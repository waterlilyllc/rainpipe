# Phase 2 å®Œäº† - ã‚¸ãƒ§ãƒ–ç®¡ç†ãƒ»ãƒãƒƒãƒå‡¦ç†

## âœ… å®Ÿè£…å®Œäº†é …ç›®

### ã‚³ã‚¢ã‚¯ãƒ©ã‚¹

#### 1. CrawlJobManager (`crawl_job_manager.rb`)
ã‚¸ãƒ§ãƒ–ã®CRUDæ“ä½œã¨ã‚¯ã‚¨ãƒªæ©Ÿèƒ½

**ãƒ¡ã‚½ãƒƒãƒ‰:**
- `create_job(raindrop_id, url, job_uuid)` - ã‚¸ãƒ§ãƒ–ä½œæˆ
- `get_job(job_id)` - ã‚¸ãƒ§ãƒ–å–å¾—
- `update_job_status(job_id, status, error_message)` - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
- `get_pending_jobs()` - ä¿ç•™ä¸­ã‚¸ãƒ§ãƒ–å–å¾—
- `get_failed_jobs_for_retry()` - ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ã‚¸ãƒ§ãƒ–å–å¾—
- `get_timeout_jobs()` - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¸ãƒ§ãƒ–å–å¾—
- `increment_retry_count(job_id)` - ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
- `get_stats()` - çµ±è¨ˆæƒ…å ±å–å¾—
- `job_exists_for_bookmark?(raindrop_id)` - ã‚¸ãƒ§ãƒ–å­˜åœ¨ç¢ºèª

#### 2. BookmarkContentFetcher (`bookmark_content_fetcher.rb`)
ã‚¸ãƒ§ãƒ–ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã¨ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**ãƒ¡ã‚½ãƒƒãƒ‰:**
- `fetch_content(raindrop_id, url)` - æœ¬æ–‡å–å¾—ã‚¸ãƒ§ãƒ–ä½œæˆ
- `update_pending_jobs()` - ä¿ç•™ä¸­ã‚¸ãƒ§ãƒ–ã®çŠ¶æ…‹æ›´æ–°ãƒ»çµæœä¿å­˜
- `save_job_result(job_id)` - å®Œäº†ã‚¸ãƒ§ãƒ–ã®çµæœä¿å­˜
- `retry_failed_jobs()` - å¤±æ•—ã‚¸ãƒ§ãƒ–ã®ãƒªãƒˆãƒ©ã‚¤
- `handle_timeout_jobs()` - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
- `print_stats()` - çµ±è¨ˆæƒ…å ±è¡¨ç¤º

**æ©Ÿèƒ½:**
- Gatherly APIã¨ã®é€£æº
- DBæ“ä½œã®æŠ½è±¡åŒ–
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- æˆåŠŸç‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆ50%ä»¥ä¸‹ã§è­¦å‘Šï¼‰

### ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### 1. fetch_bookmark_contents.rb
**å®Ÿè¡Œé »åº¦:** 1æ—¥1å›ï¼ˆæœ8æ™‚æ¨å¥¨ï¼‰

**å‡¦ç†å†…å®¹:**
1. æœ€æ–°ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯JSONèª­ã¿è¾¼ã¿
2. æœ¬æ–‡æœªå–å¾—ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æŠ½å‡º
3. å„ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«å¯¾ã—ã¦ã‚¸ãƒ§ãƒ–ä½œæˆ
4. çµ±è¨ˆæƒ…å ±å‡ºåŠ›

**è¨­å®š:**
- ç’°å¢ƒå¤‰æ•° `MAX_BOOKMARKS_PER_BATCH` ã§ãƒãƒƒãƒã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ50ï¼‰
- APIè² è·è»½æ¸›ã®ãŸã‚é©åº¦ã«sleep

#### 2. update_crawl_jobs.rb
**å®Ÿè¡Œé »åº¦:** 5åˆ†ã”ã¨

**å‡¦ç†å†…å®¹:**
1. ä¿ç•™ä¸­ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
2. å®Œäº†ã‚¸ãƒ§ãƒ–ã®çµæœä¿å­˜
3. å¤±æ•—ã‚¸ãƒ§ãƒ–ã®ãƒªãƒˆãƒ©ã‚¤
4. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¸ãƒ§ãƒ–ã®å‡¦ç†
5. çµ±è¨ˆæƒ…å ±ã¨è­¦å‘Šå‡ºåŠ›

### ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### test_content_fetch_flow.rb
ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®çµ±åˆãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆå†…å®¹:**
1. ã‚¸ãƒ§ãƒ–ä½œæˆ
2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆ10ç§’å¾…æ©Ÿï¼‰
3. çµæœç¢ºèª
4. çµ±è¨ˆæƒ…å ±è¡¨ç¤º
5. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

## ğŸ“ ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

```
/var/git/rainpipe/
â”œâ”€â”€ crawl_job_manager.rb                     # ã‚¸ãƒ§ãƒ–DBç®¡ç†
â”œâ”€â”€ bookmark_content_fetcher.rb              # ã‚¸ãƒ§ãƒ–ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
â”œâ”€â”€ fetch_bookmark_contents.rb               # æ—¥æ¬¡ãƒãƒƒãƒï¼ˆã‚¸ãƒ§ãƒ–ä½œæˆï¼‰
â”œâ”€â”€ update_crawl_jobs.rb                     # 5åˆ†ãƒãƒƒãƒï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼‰
â”œâ”€â”€ test_content_fetch_flow.rb               # çµ±åˆãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ logs/                                     # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â””â”€â”€ PHASE2_COMPLETED.md                      # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸš€ ä½¿ã„æ–¹

### 1. ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆå¿…é ˆï¼‰

`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¨­å®šï¼š

```bash
GATHERLY_API_URL=http://nas.taileef971.ts.net:3002
GATHERLY_API_KEY=your_actual_api_key_here
GATHERLY_CALLBACK_BASE_URL=http://nas.taileef971.ts.net:4567

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒãƒƒãƒã‚µã‚¤ã‚ºåˆ¶é™
MAX_BOOKMARKS_PER_BATCH=50
```

### 2. æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

#### Gatherly APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
```bash
ruby test_gatherly_integration.rb
```

#### ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
```bash
ruby test_content_fetch_flow.rb
```

### 3. ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆæ‰‹å‹•å®Ÿè¡Œ

#### æœ¬æ–‡å–å¾—ã‚¸ãƒ§ãƒ–ä½œæˆ
```bash
ruby fetch_bookmark_contents.rb
```

#### ã‚¸ãƒ§ãƒ–çŠ¶æ…‹æ›´æ–°
```bash
ruby update_crawl_jobs.rb
```

### 4. Cronã‚¸ãƒ§ãƒ–è¨­å®š

`crontab -e` ã§ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```bash
# ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æœ¬æ–‡å–å¾—ï¼ˆæœ8æ™‚ï¼‰
0 8 * * * cd /var/git/rainpipe && /usr/bin/ruby fetch_bookmark_contents.rb >> logs/fetch_contents.log 2>&1

# ã‚¸ãƒ§ãƒ–çŠ¶æ…‹æ›´æ–°ï¼ˆ5åˆ†ã”ã¨ï¼‰
*/5 * * * * cd /var/git/rainpipe && /usr/bin/ruby update_crawl_jobs.rb >> logs/update_jobs.log 2>&1
```

## ğŸ” ãƒ­ã‚°ç¢ºèª

```bash
# æœ¬æ–‡å–å¾—ãƒ­ã‚°
tail -f /var/git/rainpipe/logs/fetch_contents.log

# ã‚¸ãƒ§ãƒ–æ›´æ–°ãƒ­ã‚°
tail -f /var/git/rainpipe/logs/update_jobs.log

# ã‚¨ãƒ©ãƒ¼ã®ã¿ç¢ºèª
grep "âŒ" /var/git/rainpipe/logs/*.log
```

## ğŸ“Š å‹•ä½œç¢ºèª

### ã‚¸ãƒ§ãƒ–çµ±è¨ˆç¢ºèª

```bash
ruby -e "
require_relative 'crawl_job_manager'
manager = CrawlJobManager.new
puts manager.get_stats.inspect
"
```

### æœ¬æ–‡çµ±è¨ˆç¢ºèª

```bash
ruby -e "
require_relative 'bookmark_content_manager'
manager = BookmarkContentManager.new
puts manager.get_stats.inspect
"
```

## âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. Gatherly APIã«æ¥ç¶šã§ããªã„

```bash
# APIç–é€šç¢ºèª
curl http://nas.taileef971.ts.net:3002/

# ç’°å¢ƒå¤‰æ•°ç¢ºèª
echo $GATHERLY_API_KEY
```

### 2. ã‚¸ãƒ§ãƒ–ãŒé€²ã¾ãªã„

```bash
# ä¿ç•™ä¸­ã‚¸ãƒ§ãƒ–ç¢ºèª
sqlite3 data/rainpipe.db "SELECT * FROM crawl_jobs WHERE status='pending' LIMIT 5;"

# æ‰‹å‹•ã§çŠ¶æ…‹æ›´æ–°å®Ÿè¡Œ
ruby update_crawl_jobs.rb
```

### 3. æˆåŠŸç‡ãŒä½ã„

- ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
- Gatherly APIã®çŠ¶æ…‹ã‚’ç¢ºèª
- ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯URLã®å¦¥å½“æ€§ã‚’ç¢ºèª

### 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼

```bash
# ã‚¹ã‚­ãƒ¼ãƒç¢ºèª
sqlite3 data/rainpipe.db ".schema"

# å†åˆæœŸåŒ–ï¼ˆæ³¨æ„: ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ï¼‰
rm data/rainpipe.db
ruby db_setup.rb
```

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆPhase 3ï¼‰

### UIçµ±åˆ
- [ ] `/bookmark/:id/content` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
- [ ] æœ¬æ–‡è¡¨ç¤ºãƒ“ãƒ¥ãƒ¼ä½œæˆ
- [ ] é€±æ¬¡ã‚µãƒãƒªãƒ¼ã¸ã®çµ±åˆ
- [ ] å–å¾—çŠ¶æ…‹ã®è¡¨ç¤ºUI

### æ©Ÿèƒ½æ‹¡å¼µ
- [ ] Webhookå—ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
- [ ] æœ¬æ–‡ã®å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½
- [ ] æœ¬æ–‡ã‹ã‚‰ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
- [ ] æœ¬æ–‡è¦ç´„ç”Ÿæˆï¼ˆGPTåˆ©ç”¨ï¼‰

## ğŸ“ å®Ÿè£…ãƒ¡ãƒ¢

### APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ 

Gatherly APIã®çµæœã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«æœ¬æ–‡ã‚’å–å¾—ï¼š

```ruby
result = gatherly_client.get_job_result(job_id)
items = result[:items]
body = items.first[:body]

content = body[:text] || body[:content]
title = body[:title]
```

### ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

- æœ€å¤§3å›ã¾ã§è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
- æ–°ã—ã„ã‚¸ãƒ§ãƒ–UUIDã§å†ä½œæˆ
- å…ƒã®ã‚¸ãƒ§ãƒ–ã®retry_countã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
- max_retriesã«é”ã—ãŸã‚‰ 'failed' ã«å›ºå®š

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†

- ã‚¸ãƒ§ãƒ–ä½œæˆã‹ã‚‰24æ™‚é–“çµŒéã§è‡ªå‹•ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- `update_crawl_jobs.rb` ã§å‡¦ç†
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ 'failed' ã«å¤‰æ›´

### æˆåŠŸç‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

- ç·ã‚¸ãƒ§ãƒ–æ•°ãŒ10ä»¥ä¸Šã§æœ‰åŠ¹
- æˆåŠŸç‡50%ä»¥ä¸‹ã§è­¦å‘Šãƒ­ã‚°å‡ºåŠ›
- `print_stats()` ã§è‡ªå‹•ãƒã‚§ãƒƒã‚¯

## âœ… Phase 2 å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] CrawlJobManager ã‚¯ãƒ©ã‚¹å®Ÿè£…
- [x] BookmarkContentFetcher ã‚¯ãƒ©ã‚¹å®Ÿè£…
- [x] fetch_bookmark_contents.rb ä½œæˆ
- [x] update_crawl_jobs.rb ä½œæˆ
- [x] çµ±åˆãƒ†ã‚¹ãƒˆä½œæˆ
- [x] ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
- [x] çµ±è¨ˆæƒ…å ±æ©Ÿèƒ½
- [x] ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
- [x] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
- [ ] Cronã‚¸ãƒ§ãƒ–è¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿…è¦ï¼‰
- [ ] æœ¬ç•ªç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

## ğŸ‰ Phase 2 å®Ÿè£…å®Œäº†ï¼

Phase 1ã®åŸºç›¤ã«åŠ ãˆã¦ã€ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®æœ¬æ–‡å–å¾—ãƒ•ãƒ­ãƒ¼ãŒå®Œæˆã—ã¾ã—ãŸã€‚

æ¬¡ã¯ï¼š
1. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
2. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
3. Cronã‚¸ãƒ§ãƒ–ã‚’è¨­å®š
4. Phase 3ï¼ˆUIçµ±åˆï¼‰ã¸é€²ã‚€
