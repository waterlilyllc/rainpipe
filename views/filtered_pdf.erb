<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rainpipe - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ PDF ç”Ÿæˆ</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .filtered-pdf-form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #495057;
    }

    .form-group textarea,
    .form-group input[type="text"],
    .form-group input[type="date"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group textarea:focus,
    .form-group input[type="text"]:focus,
    .form-group input[type="date"]:focus {
      outline: none;
      border-color: #495057;
      box-shadow: 0 0 0 3px rgba(73, 80, 87, 0.1);
    }

    .form-group.checkbox {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .form-group.checkbox input[type="checkbox"] {
      width: auto;
      margin-right: 0.5rem;
      cursor: pointer;
    }

    .form-group.checkbox label {
      margin-bottom: 0;
      margin-right: 0.5rem;
      cursor: pointer;
    }

    .date-range-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .submit-btn {
      background-color: #495057;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
    }

    .submit-btn:hover {
      background-color: #343a40;
    }

    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      border: 1px solid #f5c6cb;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      border: 1px solid #c3e6cb;
    }

    .info-text {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ§ï¸ Rainpipe</h1>
    <p>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¥ PDF ç”Ÿæˆ</p>
  </header>

  <nav class="main-nav">
    <div class="nav-links">
      <a href="/" class="nav-button">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="/weekly" class="nav-button">ğŸ“… é€±é–“è¡¨ç¤º</a>
      <a href="/monthly" class="nav-button">ğŸ“† æœˆé–“è¡¨ç¤º</a>
      <a href="/search" class="nav-button">ğŸ” æ¤œç´¢</a>
    </div>
  </nav>

  <main>
    <div class="filtered-pdf-form">
      <h2>ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¥ PDF ã‚’ç”Ÿæˆ</h2>

      <% if @error_message %>
        <div class="error-message">
          âŒ <%= @error_message %>
        </div>
      <% end %>

      <% if @success_message %>
        <div class="success-message">
          âœ… <%= @success_message %>
        </div>
      <% end %>

      <form action="/filtered_pdf/generate" method="POST">
        <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› -->
        <div class="form-group">
          <label for="keywords">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ *</label>
          <textarea
            id="keywords"
            name="keywords"
            placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆè¤‡æ•°ã®å ´åˆã¯æ”¹è¡Œã¾ãŸã¯ , ã§åŒºåˆ‡ã‚‹ï¼‰"
            required><%= @keywords %></textarea>
          <p class="info-text">ä¾‹: Claude, æ©Ÿæ¢°å­¦ç¿’, Ruby</p>
        </div>

        <!-- æ—¥ä»˜ç¯„å›² -->
        <div class="form-group">
          <label>æœŸé–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: éå»3ãƒ¶æœˆï¼‰</label>
          <div class="date-range-group">
            <div>
              <label for="date_start" style="font-size: 0.9rem; display: inline;">é–‹å§‹æ—¥</label>
              <input
                type="date"
                id="date_start"
                name="date_start"
                value="<%= @date_start %>">
            </div>
            <div>
              <label for="date_end" style="font-size: 0.9rem; display: inline;">çµ‚äº†æ—¥</label>
              <input
                type="date"
                id="date_end"
                name="date_end"
                value="<%= @date_end %>">
            </div>
          </div>
          <p class="info-text">æŒ‡å®šã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¯„å›²ãŒä½¿ç”¨ã•ã‚Œã¾ã™</p>
        </div>

        <!-- Kindle é€ä¿¡ -->
        <div class="form-group checkbox">
          <input
            type="checkbox"
            id="send_to_kindle"
            name="send_to_kindle"
            value="true"
            <%= 'checked' if @send_to_kindle %>>
          <label for="send_to_kindle">Kindle ã«é€ä¿¡ã™ã‚‹</label>
        </div>

        <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
        <button type="submit" class="submit-btn">ğŸ“„ PDF ã‚’ç”Ÿæˆ</button>
      </form>

      <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #dee2e6;">
        <h3>ä½¿ã„æ–¹</h3>
        <ul style="margin-left: 1rem; color: #6c757d; font-size: 0.95rem;">
          <li>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„</li>
          <li>è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ãŸå ´åˆã€ã„ãšã‚Œã‹ã«åˆè‡´ã™ã‚‹ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒå¯¾è±¡ã§ã™ï¼ˆOR æ¡ä»¶ï¼‰</li>
          <li>æ—¥ä»˜ç¯„å›²ã‚’æŒ‡å®šã—ãªã„å ´åˆã€éå»3ãƒ¶æœˆã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒå¯¾è±¡ã§ã™</li>
          <li>Kindle ã«é€ä¿¡ã™ã‚‹å ´åˆã€ã‚ã‚‰ã‹ã˜ã‚ Kindle ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„</li>
        </ul>
      </div>
    </div>
    <!-- Task 6.2: History Selector -->
    <div id="history-selector-container" style="display: none; margin-top: 2rem;"></div>

    <!-- Task 6.1: LogPanel -->
    <div id="log-panel" style="display: none; margin-top: 2rem;"></div>

    <!-- Task 5.2: ProgressPanel -->
    <div id="progress-panel" style="display: none; margin-top: 2rem;"></div>

    <!-- Task 5.4: CompletionPanel -->
    <div id="completion-panel" style="display: none; margin-top: 2rem;"></div>

    <!-- Error Panel -->
    <div id="form-error-panel" style="display: none; margin-top: 1rem;">
      <div class="error-message">
        <span class="error-message-text"></span>
      </div>
    </div>
  </main>

  <footer>
    <p><a href="/">ãƒ›ãƒ¼ãƒ </a> | <a href="/weekly">é€±é–“è¡¨ç¤º</a> | <a href="/æœˆé–“è¡¨ç¤º</a> | <a href="/search">æ¤œç´¢</a></p>
  </footer>

  <!-- Task 5.1: PollingManager Script -->
  <script src="/js/polling_manager.js"></script>
  <!-- Task 5.2: ProgressPanel Script -->
  <script src="/js/progress_panel.js"></script>
  <!-- Task 5.4: CompletionPanel Script -->
  <script src="/js/completion_panel.js"></script>
  <!-- Task 6.1: LogPanel Script -->
  <script src="/js/log_panel.js"></script>
  <!-- Task 6.2: HistorySelector Script -->
  <script src="/js/history_selector.js"></script>
  <!-- Task 6.3: ReadOnlyEnforcer Script -->
  <script src="/js/read_only_enforcer.js"></script>
  <!-- Task 7.1-7.3: FormIntegration Script -->
  <script src="/js/form_integration.js"></script>

  <script>
    // Initialize all components (Task 7.1-7.3: FormIntegration)
    document.addEventListener('DOMContentLoaded', function() {
      // Set default dates
      const dateStartInput = document.getElementById('date_start');
      const dateEndInput = document.getElementById('date_end');

      if (!dateStartInput.value) {
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
        dateStartInput.value = threeMonthsAgo.toISOString().split('T')[0];
      }

      if (!dateEndInput.value) {
        const today = new Date();
        dateEndInput.value = today.toISOString().split('T')[0];
      }

      // Initialize FormIntegration (Task 7.1-7.3)
      // This handles AJAX form submission and integrates all progress components
      window.formIntegration = new FormIntegration({
        formSelector: 'form',
        progressPanelSelector: '#progress-panel',
        completionPanelSelector: '#completion-panel',
        errorPanelSelector: '#form-error-panel',
        logPanelSelector: '#log-panel',
        historySelectorContainer: '#history-selector-container'
      });

      // Optional: Initialize history selector if viewing past jobs
      // This would be done by FormIntegration when needed
    });
  </script>
</body>
</html>
