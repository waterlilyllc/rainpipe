<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€±æ¬¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚µãƒãƒªãƒ¼ - <%= @week_start %> - Rainpipe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .meta {
      color: #666;
      font-size: 0.9rem;
    }
    .action-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #3498db;
      color: white;
    }
    .btn-primary:hover {
      background: #2980b9;
    }
    .btn-secondary {
      background: #ecf0f1;
      color: #34495e;
    }
    .btn-secondary:hover {
      background: #bdc3c7;
    }
    .keyword-section {
      background: white;
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .keyword-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      cursor: pointer;
    }
    .keyword-title {
      font-size: 1.4rem;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .article-count {
      background: #3498db;
      color: white;
      padding: 2px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
    }
    .keyword-content {
      display: block;
    }
    .keyword-content.collapsed {
      display: none;
    }
    .summary-section {
      margin-bottom: 20px;
    }
    .summary-section h3 {
      font-size: 1.1rem;
      color: #34495e;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .summary-content {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      line-height: 1.8;
    }
    .articles-list {
      margin-top: 15px;
      padding: 15px;
      background: #f0f7ff;
      border-radius: 6px;
    }
    .article-item {
      margin-bottom: 8px;
    }
    .article-link {
      color: #3498db;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .article-link:hover {
      text-decoration: underline;
    }
    .overall-insights {
      background: #fff8dc;
      border-radius: 8px;
      padding: 25px;
      margin-top: 30px;
      border-left: 4px solid #f39c12;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .toggle-icon {
      font-size: 0.8rem;
      transition: transform 0.2s;
    }
    .toggle-icon.collapsed {
      transform: rotate(-90deg);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š é€±æ¬¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚µãƒãƒªãƒ¼</h1>
      <p class="meta">
        <%= Date.parse(@week_start).strftime('%Yå¹´%mæœˆ%dæ—¥') %> - <%= Date.parse(@week_end).strftime('%mæœˆ%dæ—¥') %>ã®é€±
      </p>
      
      <div class="action-buttons">
        <% if @summary_exists %>
          <button class="btn btn-secondary" onclick="regenerateSummary()">
            ğŸ”„ å†ç”Ÿæˆ
          </button>
        <% else %>
          <button class="btn btn-primary" onclick="generateSummary()">
            âœ¨ ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
          </button>
        <% end %>
        <a href="/weekly" class="btn btn-secondary">
          â† é€±æ¬¡ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        </a>
      </div>
    </div>
    
    <div id="content">
      <% if @summary_exists && @summary_data %>
        <% @summary_data['keywords'].each do |keyword, data| %>
          <div class="keyword-section">
            <div class="keyword-header" onclick="toggleSection(this)">
              <h2 class="keyword-title">
                <%= keyword %>
                <span class="article-count"><%= data['article_count'] %>è¨˜äº‹</span>
              </h2>
              <span class="toggle-icon">â–¼</span>
            </div>
            
            <div class="keyword-content">
              <% if data['summary'] %>
                <div class="summary-section">
                  <div class="summary-content"><%= data['summary'] %></div>
                </div>
              <% end %>
              
              <% if data['articles'] && data['articles'].any? %>
                <div class="articles-list">
                  <strong>ğŸ“° å‚ç…§è¨˜äº‹:</strong>
                  <% data['articles'].each do |article| %>
                    <div class="article-item">
                      â€¢ <a href="<%= article['url'] %>" target="_blank" class="article-link">
                        <%= article['title'] %>
                      </a>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <% if @summary_data['overall_insights'] %>
          <div class="overall-insights">
            <h2 style="margin-bottom: 15px;">ğŸ’¡ ä»Šé€±ã®ç·æ‹¬</h2>
            <p><%= @summary_data['overall_insights'] %></p>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <h2>ğŸ“ ã¾ã ã‚µãƒãƒªãƒ¼ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
          <p style="margin-top: 10px;">ã€Œã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ä»Šé€±ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      <% end %>
    </div>
  </div>
  
  <script>
    function toggleSection(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('.toggle-icon');
      
      content.classList.toggle('collapsed');
      icon.classList.toggle('collapsed');
    }
    
    function generateSummary() {
      const content = document.getElementById('content');
      content.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p style="margin-top: 20px;">ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆä¸­ã§ã™...<br>ã“ã®å‡¦ç†ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p></div>';
      
      fetch('/weekly/<%= @week_start %>/generate-summary', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('ã‚µãƒãƒªãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
          location.reload();
        }
      })
      .catch(error => {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
        location.reload();
      });
    }
    
    function regenerateSummary() {
      if (confirm('ç¾åœ¨ã®ã‚µãƒãƒªãƒ¼ã‚’å‰Šé™¤ã—ã¦å†ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ')) {
        generateSummary();
      }
    }
  </script>
</body>
</html>